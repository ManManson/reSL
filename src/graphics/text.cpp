#include "text.h"

#include "color.h"
#include "glyph.h"
#include <game/resources/text_glyphs.h>

namespace resl {

/* 1d7d:2969 : 256 bytes */
static const std::uint8_t g_charTraits[256] = {
    0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x21, 0x21, 0x21,
    0x21, 0x21, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
    0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x01, 0x40, 0x40, 0x40,
    0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40,
    0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x40, 0x40,
    0x40, 0x40, 0x40, 0x40, 0x40, 0x14, 0x14, 0x14, 0x14, 0x14, 0x14, 0x04,
    0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04,
    0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x40, 0x40, 0x40, 0x40, 0x40,
    0x40, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x08, 0x08, 0x08, 0x08, 0x08,
    0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08,
    0x08, 0x08, 0x08, 0x40, 0x40, 0x40, 0x40, 0x20, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00
};

/* 1d7d:2962 : 2 bytes */
std::int16_t g_textSpacing = 1;

/* 1b06:1552 */
void drawText(std::int16_t x, std::int16_t y, const char* s, Color color)
{
    std::uint8_t oldGlyphHeight = g_glyphHeight;
    for (; *s; ++s) {
        std::uint8_t shiftedChar = *s - 0x20;
        const TextGlyph& g = g_textGlyphs[shiftedChar];
        g_glyphHeight = g.height;
        std::int16_t tileY = g.yOffset + y;
        if (g.width <= 8)
            drawGlyphW8(g.glyph, x, tileY, color);
        else
            drawGlyphW16(g.glyph, x, tileY, color);
        x += g.width + g_textSpacing;
    }
    g_glyphHeight = oldGlyphHeight;
}

/* 1b06:077c */
void drawTextSmall(std::int16_t, std::int16_t, const char*, Color)
{
    // TODO implement
}

/* 15e8:0984 */
std::int16_t measureText(const char* s)
{
    std::int16_t width = 0;
    for (; *s; ++s) {
        width += g_textSpacing + 9;
        if (g_charTraits[*s] & (4 | 2))
            width += 4;
    }
    return width;
}

} // namespace resl
